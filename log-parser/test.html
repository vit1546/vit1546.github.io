<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<title>Installation logs parser</title>

<body>
    <div class="main-wrap">
        <h1>Add-in Installation Log Parser</h1>
        <div class="dropzone" id="dropzone">
            <div class="dz-message">Click or drag your files here to upload.</div>
            <input class="dropzone-input" type="file">
        </div>
        <div id="result"></div>
    </div>
    <script type="text/javascript">

    	var oldVersion;    	
    	var oldVersionPattern = /SOURCEMGMT: Trying source [^}]+}([^\\]+)/i;

        function loadFileAsText(files) {
            oldVersion = "";
            var i = 0;
            var fileReader = new FileReader();
            fileReader.onload = function(fileLoadedEvent) {
                var textFromFileLoaded = fileLoadedEvent.target.result;
                parseLog(textFromFileLoaded);
                i++;
                if (i < files.length) {
                    this.readAsText(files[i], "UTF-8");
                } else {
                    showResults();
                }
            };

            fileReader.readAsText(files[i], "UTF-8");
        }

        function showResults() {
        	document.getElementById("result").innerText = 
        		oldVersion ? oldVersion : "Failed to find version";
        }

        function parseLog(log) {
        	var match = log.match(oldVersionPattern);

        	if(match && match[1]){
        		oldVersion = match[1];
        	}
        }

        var holder = document.getElementById('dropzone');
        holder.ondragover = function() {
            this.classList.add('dz-drag-hover');
            return false;
        };
        holder.ondragleave = function() {
            this.classList.remove('dz-drag-hover');
            return false;
        };
        holder.ondrop = function(e) {
            this.classList.remove('dz-drag-hover');
            e.preventDefault();
            loadFileAsText(e.dataTransfer.files);
        }
    </script>
</body>

</html>