/* Copyright Copyright 2014 Epic Systems Corporation. */

/*! Copyright (c) Epic Systems Corporation 2012 */
if(typeof WP==="undefined")var WP={};if(typeof WP.Controls==="undefined")WP.Controls={};if(typeof WP.Controls.ImageViewer==="undefined"){WP.Controls.ImageViewer=function(i,m,j,f,l,o,k,n,a,p){var e="disabled",d=false,c=true,b=this,g=b,h;f=f&&window.location.href.indexOf("printmode=true")===-1;b.imgsContainer=createElement("div","imagescontainer");b.ID=i;if(f!==c&&f!==d)f=c;b.visibleLabel=document.getElementById("iframelabel");b.AllowEdit=f;b.ImageList=[];b.iframe=document.getElementById("iframe"+i);b.maxDescLength=l||200;b.formName=o||"";b.afterValidate=k||null;b.maxImages=n||5;m.appendChild(b.imgsContainer);b.isPrintMode=window.location.href.indexOf("printmode")>-1;if(b.isPrintMode)b.imgsContainer.style.width="99%";b.alertDiv=document.getElementById("imgalert");b.setActivity=SetActivity;b.setActivity();b.mode=parseInt(p||3,10);if(a){a.mode=3;h=a.parentNode.lastChild.previousSibling;b.browse=a;a.writeError=function(b){if(a.timedOut===c)a.timedOut=d;else if(a.dontOverwriteError!==c)h.innerHTML=b;a.uploading=d;spin.hide();removeClassNames(a.button,e);g.setActivity()};a.beforeupload=function(){a.writeError("");spin.show();applyClass(a.button,e);g.setActivity()};a.setDisabled=function(b){var f,g=b?applyClass:removeClassNames;g(a.button,e);a.disabled=b;if(a.setDisabledInner)a.setDisabledInner(b);else if(b===c){a.dontOverwriteError=c;f=function(){if(!a.setDisabledInner){window.setTimeout(f,1);return}a.setDisabledInner(b);a.dontOverwriteError=d};f()}};a.style.width=a.button.offsetWidth+10+"px";a.style.height=a.button.offsetHeight+10+"px";a.onupload=function(b,e,c,d){g.addImage(b,e,c,d);g.transferToForm();a.button.style.display=""}}b.setSerialized(j);return b};WP.Controls.ImageViewer.prototype.updateLabel=function(f,a){var c=this,b,d,h,g,e;b=c.imgsContainer.children[f];d=b.children[2];if(d.value!==a)d.value=a;c.ImageList[f].label=a;b=b.children[1].children[0];b.alt=a;b.title=a;e=c.ImageList[f];h="upload.asp?mode=update&thumb="+(e.srcThumb+"&full="+e.srcFull+"&label="+encodeURI(a));try{g=new AJAXHandler;g.init(h,function(){},"POST","1",g.RESPONSETYPE_COMPLETE)}catch(i){}c.reserialize();c.setActivity()};WP.Controls.ImageViewer.prototype.addImage=function(e,i,A,w){var t="click",k="filedescription",z="imagediv",s="showfile.asp?key=",q="img",p="uploadedimage",o=true,y="filecontainer",a=this;if(typeof e==="string")try{e=parseInt(e,10)}catch(D){return}if(a.imageCount()>=a.maxImages)return false;else if(e!==1&&e!==2&&e!==3)return false;var b,d,u,f,g,B,C,r,n,c,v,m,l,h,x,j;b=a.ImageList.length;d=createElement("div",y,y+b);r=createElement("div","buttondiv");g=createElement("a","zoom");$T(g," ");g.href="#";C=createImage("zoom","","magnify.png","View Full Size");g.appendChild(C);g.tabindex="0";r.appendChild(g);if(a.AllowEdit===o){f=createElement("a","deletex");$T(f," ");f.href="#";f.tabindex="0";B=createImage("deletex","","close.png","Delete");f.appendChild(B);r.appendChild(f)}d.appendChild(r);if(e===2)l=createImage(p,q+b,"msgattachment_pdf.png",i);else if(e===3)l=createImage(p,q+b,"msgattachment_video.png",i);else{l=createImage(p,q+b,"",i);l.src=s+(A||w)}u=createElement("div",p,z+b);u.appendChild(l);d.appendChild(u);if(a.AllowEdit===o){n=createElement("label",k);n.setAttribute("for",k+b);$T(n,"Enter Label:");n.title="Please provide a label or very short description for your image.";d.appendChild(n);c=createElement("textarea",k,k+b);c.setAttribute("for",z+b);c.value=i;d.appendChild(c);v=createElement("p","helptext imagelabelerror");d.appendChild(v);WP.Validators.Text.MaxLengthAndRequired(c,"<span class=\"clearlabel\">Error: </span>Label is required.",a.maxDescLength,v,a.formName,a.afterValidate);window.setTimeout(function(){c.focus()},1)}else{m=createElement("h3",k,k+b);$T(m,i);m.title=i;m.setAttribute("for",q+b);d.appendChild(m)}a.imgsContainer.appendChild(d);x=a;h={srcThumb:A,srcFull:w,imageType:e,label:i,del:function(){x.deleteImage(b)},mag:function(){window.open(s+w)},upd:function(){x.updateLabel(b,c.value)},labelObj:c,foc:function(){c.select()}};if(!a.isPrintMode){WP.Events.addListener(g,t,h.mag);WP.Events.addListener(l,t,h.mag)}if(a.AllowEdit===o){WP.Events.addListener(f,t,h.del);WP.Events.addListener(c,"change",h.upd);WP.Events.addListener(c,"focus",h.foc)}a.ImageList[b]=h;j=a.imgsContainer.parentNode;j.style.display="";j=j.previousSibling;if(j&&j.tagName==="H2")j.style.display="";a.reserialize();a.transferCorrectLabel();if(a.iframe)if(a.imageCount()===a.maxImages){a.iframe.setDisabled(o);if(a.maxImages===1)$T(a.alertDiv,"You may only upload 1 attachment.");else $T(a.alertDiv,decodeMnemonics("You may only upload @MYCHART@MAXIMAGES@ attachments.",{"@MYCHART@MAXIMAGES@":a.maxImages}));a.alertDiv.className="helptext"}else a.iframe.setDisabled(false);a.singleWidth=d.scrollWidth+15;if(!a.isPrintMode){a.singleWidth=d.scrollWidth+15;a.imgsContainer.style.width=a.singleWidth*a.imageCount()+"px"}matchWrapHeight();setAppropriateHeight();return b};WP.Controls.ImageViewer.prototype.setSerialized=function(a){var c=this,g,f,e,b,d;c.serializedData=a;c.clear();g=String.fromCharCode(9);f=String.fromCharCode(10);a=a.replace(/`~`z_/g,g);a=a.replace(/`~~`z_/g,f);e=a.split(g);for(d=0;d<e.length;d++){b=e[d].split(f);b.length===4&&c.addImage(b[0],b[1],b[2],b[3])}c.transferToForm();c.setActivity();c.transferCorrectLabel()};WP.Controls.ImageViewer.prototype.reserialize=function(){var c=this,a,b,g,d,e,f;g=String.fromCharCode(9);d=String.fromCharCode(10);f=c.ImageList;b="";for(e=0;e<f.length;e++){a=f[e];if(typeof a.label!=="undefined"){a.label=a.label.replace(/(\t|\n|\r)/g," ");b+=g+a.imageType+d+a.label+d+a.srcThumb+d+a.srcFull}}b=b.substr(1);c.serializedData=b;c.transferToForm();c.setActivity()};WP.Controls.ImageViewer.prototype.deleteImage=function(e){var d="click",a=this,b,c,f,g;b=a.imgsContainer.children[e];c=a.ImageList[e];WP.Events.removeListener(b.children[0].children[0],d,c.mag);WP.Events.removeListener(b.children[1].firstChild,d,c.mag);a.AllowEdit===true&&WP.Events.removeListener(b.children[0].children[1],d,c.del);WP.Events.removeListener(b.children[3],"change",c.upd);b.children[3].removeMaxLength();clearElement(b);b.style.display="none";g="upload.asp?mode=delete&thumb="+(c.srcThumb+"&full="+c.srcFull);try{f=new AJAXHandler;f.init(g,function(){},"POST","1",f.RESPONSETYPE_COMPLETE)}catch(h){}a.ImageList[e]={};if(a.imageCount()===0){a.clear();matchWrapHeight()}else a.reserialize();a.transferCorrectLabel();if(a.imageCount()<a.maxImages&&a.iframe)if(a.imageCount()===a.maxImages-1){a.iframe.setDisabled(false);$T(a.alertDiv,"");a.alertDiv.className="alert"}a.imgsContainer.style.width=a.singleWidth*a.imageCount()+"px";setAppropriateHeight()};WP.Controls.ImageViewer.prototype.clear=function(){var b=this,c,a,d;d=b.ImageList;for(c=0;c<d.length;c++)d[c].srcFull&&b.deleteImage(c);delete b.ImageList;b.ImageList=[];a=b.imgsContainer;a.innerHTML="";a=a.parentNode;a.style.display="none";a=a.previousSibling;if(a&&a.tagName==="H2")a.style.display="none";b.serializedData="";b.transferToForm();b.iframe&&b.iframe.setDisabled(false);b.setActivity()};WP.Controls.ImageViewer.prototype.transferToForm=function(){var a=document.getElementById(this.ID);if(a)a.value=this.serializedData;this.setActivity()};WP.Controls.ImageViewer.prototype.imageCount=function(){for(var b=this.ImageList,c=0,a=0;a<b.length;a++)if(b[a]&&(b[a].srcThumb||b[a].srcFull))c++;return c};WP.Controls.ImageViewer.uploadLabels=[["Attach an image:","Attach another image:"],["Attach a video:","Attach another video:"],["Attach an image or video:","Attach another image or video:"]];WP.Controls.ImageViewer.prototype.transferCorrectLabel=function(){var a=this.imageCount()===0?0:1;$T(this.visibleLabel,WP.Controls.ImageViewer.uploadLabels[this.mode-1][a])}}